---
name: "Sync chart and image versions with rancher/rke2-charts"

scms:
  rke2:
    kind: "github"
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      username: "{{ requiredEnv .github.username }}"
      token: '{{ requiredEnv .github.token }}'
      owner: rancher
      repository: rke2
      branch: master

sources:
  checkSync:
    name: "Check if sync is needed"
    kind: "shell"
    spec:
      command: |
        #!/bin/sh
        set -eu
        
        CHART_VERSIONS_FILE="charts/chart_versions.yaml"
        RKE2_CHARTS_URL="https://rke2-charts.rancher.io/index.yaml"
        
        # List of charts to check (space-separated for POSIX sh compatibility)
        charts="rke2-cilium rke2-canal rke2-coredns rke2-metrics-server rke2-multus rke2-flannel"
        
        needs_update=false
        
        for chart in $charts; do
          # Extract versions using yq v4 syntax
          latest_version=$(curl -sfL "${RKE2_CHARTS_URL}" | yq eval '.entries."'${chart}'"[].version' - | sort -rV | head -n 1)
          current_version=$(yq eval '.charts[] | select(.filename == "/charts/'${chart}'.yaml") | .version' ${CHART_VERSIONS_FILE})
          
          if [ -n "${latest_version}" ] && [ "${latest_version}" != "null" ] && [ "${current_version}" != "${latest_version}" ]; then
            echo "update-needed"
            exit 0
          fi
        done
        
        echo "no-update"

conditions:
  shouldSync:
    name: "Check if any charts need to be updated"
    kind: shell
    sourceid: checkSync
    spec:
      command: |
        #!/bin/sh
        if [ "{{ source `checkSync` }}" = "update-needed" ]; then
          exit 0
        else
          exit 1
        fi

targets:
  syncCharts:
    name: "Sync charts and images from rke2-charts"
    kind: "shell"
    scmid: "rke2"
    sourceid: checkSync
    spec:
      command: bash ./updatecli/scripts/sync_rke2_charts.sh
      changedif:
        kind: file/checksum
        spec:
          files:
            - charts/chart_versions.yaml
            - scripts/build-images
            - Dockerfile.windows

actions:
  github:
    kind: "github/pullrequest"
    scmid: "rke2"
    title: "Sync chart and image versions with rancher/rke2-charts main"
    spec:
      automerge: false
      draft: false
      mergemethod: squash
      parent: false
      description: |
        Updates chart versions and corresponding container images to match the latest releases in rancher/rke2-charts main branch.
        
        This PR is automatically generated by updatecli to keep rke2 charts and images in sync with the upstream rke2-charts repository.
        
        ## Changes
        - Updates chart versions in `charts/chart_versions.yaml`
        - Updates corresponding hardened images in `scripts/build-images`
        - Updates CNI versions in `Dockerfile.windows`
        
        Please review the changes and ensure all image tags match the chart dependencies before merging.
