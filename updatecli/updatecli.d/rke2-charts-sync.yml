---
name: "Sync chart and image versions with rancher/rke2-charts"

scms:
  rke2:
    kind: "github"
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      username: "{{ requiredEnv .github.username }}"
      token: '{{ requiredEnv .github.token }}'
      owner: rancher
      repository: rke2
      branch: master

sources:
  rke2-charts-sync:
    name: "Trigger sync from rke2-charts"
    kind: "shell"
    spec:
      # This will always return a timestamp to trigger the sync
      command: date +%Y%m%d%H%M%S

conditions:
  shouldSync:
    name: "Check if any charts need to be updated"
    kind: shell
    spec:
      # Check if any chart versions differ from rke2-charts
      command: |
        #!/bin/bash
        set -eu
        
        CHART_VERSIONS_FILE="charts/chart_versions.yaml"
        RKE2_CHARTS_URL="https://rke2-charts.rancher.io/index.yaml"
        
        charts=(
          "rke2-cilium"
          "rke2-canal"
          "rke2-coredns"
          "rke2-metrics-server"
          "rke2-multus"
          "rke2-flannel"
        )
        
        needs_update=false
        
        for chart in "${charts[@]}"; do
          latest_version=$(curl -sfL "${RKE2_CHARTS_URL}" | yq -r '.entries.'"${chart}"'[].version' | sort -rV | head -n 1)
          current_version=$(yq -r '.charts[] | select(.filename == "/charts/'"${chart}"'.yaml") | .version' ${CHART_VERSIONS_FILE})
          
          if [ -n "${latest_version}" ] && [ "${latest_version}" != "null" ] && [ "${current_version}" != "${latest_version}" ]; then
            echo "[INFO] Chart ${chart} needs update: ${current_version} -> ${latest_version}"
            needs_update=true
          fi
        done
        
        if [ "${needs_update}" = "true" ]; then
          exit 0
        else
          echo "[INFO] All charts are up to date"
          exit 1
        fi

targets:
  syncCharts:
    name: "Sync charts and images from rke2-charts"
    kind: "shell"
    scmid: "rke2"
    spec:
      command: bash ./updatecli/scripts/sync_rke2_charts.sh
      changedif:
        kind: file/checksum
        spec:
          files:
            - charts/chart_versions.yaml
            - scripts/build-images

actions:
  github:
    kind: "github/pullrequest"
    scmid: "rke2"
    title: "Sync chart and image versions with rancher/rke2-charts main"
    spec:
      automerge: false
      draft: false
      mergemethod: squash
      parent: false
      description: |
        Updates chart versions and corresponding container images to match the latest releases in rancher/rke2-charts main branch.
        
        This PR is automatically generated by updatecli to keep rke2 charts and images in sync with the upstream rke2-charts repository.
        
        ## Changes
        - Updates chart versions in `charts/chart_versions.yaml`
        - Updates corresponding hardened images in `scripts/build-images`
        
        Please review the changes and ensure all image tags match the chart dependencies before merging.
