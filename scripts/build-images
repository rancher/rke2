#!/usr/bin/env bash
set -ex

cd $(dirname $0)/..

source ./scripts/version.sh

./scripts/build-image-runtime

awk '{print $1}' << EOF > build/images-runtime.txt
    ${REGISTRY}/${REPO}/${PROG}-runtime:${DOCKERIZED_VERSION}
EOF

xargs -n1 -t docker image pull --quiet << EOF >> build/images-core.txt
    docker.io/rancher/hardened-kubernetes:${KUBERNETES_IMAGE_TAG}
    docker.io/rancher/hardened-calico:v3.13.3-build20210223
    docker.io/rancher/hardened-coredns:v1.6.9-build20210223
    docker.io/rancher/hardened-etcd:v3.4.13-k3s1-build20210223
    docker.io/rancher/hardened-flannel:v0.14.1-build20211022
    docker.io/rancher/hardened-k8s-metrics-server:v0.3.6-build20210223
    docker.io/rancher/klipper-helm:v0.4.3-build20210225
    docker.io/rancher/pause:3.2
    docker.io/rancher/nginx-ingress-controller:nginx-1.0.2-hardened1
    docker.io/rancher/mirrored-ingress-nginx-kube-webhook-certgen:v1.0
EOF


# Continue to provide a legacy airgap archive set with the default CNI images
cat build/images-runtime.txt build/images-core.txt > build/images.txt
